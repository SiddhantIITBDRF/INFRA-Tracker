<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>IIT Bombay â€” Infrastructure Projects Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg: #f5f6fa;
  --surface: #ffffff;
  --surface2: #f0f1f5;
  --border: #e4e6ef;
  --text: #1a1d2e;
  --muted: #8b90a7;
  --sidebar-bg: #1a1d2e;
  --sidebar-active: #2563eb;
  --accent: #2563eb;
  --accent2: #1e4fd8;
  --tag-bg: #eef2ff;
  --tag-color: #2563eb;
  --green: #16a34a;
  --green-bg: #f0fdf4;
  --amber: #b45309;
  --amber-bg: #fffbeb;
  --red: #dc2626;
  --red-bg: #fef2f2;
  --font: 'Poppins', sans-serif;
  --shadow: 0 1px 3px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04);
  --shadow-md: 0 4px 16px rgba(0,0,0,.08);
  --radius: 10px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: var(--font); font-size: 13.5px; line-height: 1.55; min-height: 100vh; }
.layout { display: flex; min-height: 100vh; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: 240px; background: var(--sidebar-bg);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 20;
  transition: width .25s cubic-bezier(.4,0,.2,1);
  overflow: hidden;
}
.sidebar.collapsed { width: 58px; }

/* Toggle button */
.sidebar-toggle {
  position: absolute; top: 18px; right: -13px;
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--sidebar-bg); border: 1.5px solid rgba(255,255,255,.12);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 30; transition: all .2s;
  color: #7b829e;
}
.sidebar-toggle:hover { background: var(--accent); border-color: var(--accent); color: #fff; }
.sidebar-toggle svg { width: 12px; height: 12px; transition: transform .25s; flex-shrink: 0; }
.sidebar.collapsed .sidebar-toggle svg { transform: rotate(180deg); }

.sidebar-logo {
  padding: 24px 22px 20px;
  border-bottom: 1px solid rgba(255,255,255,.06);
  white-space: nowrap; overflow: hidden;
}
.sidebar-logo .inst {
  font-size: .6rem; font-weight: 600; letter-spacing: .12em;
  text-transform: uppercase; color: #5b6481; margin-bottom: 5px;
  opacity: 1; transition: opacity .2s;
}
.sidebar-logo .title {
  font-size: .92rem; font-weight: 600; color: #fff; line-height: 1.3;
  opacity: 1; transition: opacity .2s;
}
.sidebar-logo .logo-icon {
  font-size: 1.2rem; display: none; color: #fff;
}
.sidebar.collapsed .sidebar-logo .inst,
.sidebar.collapsed .sidebar-logo .title { opacity: 0; display: none; }
.sidebar.collapsed .sidebar-logo .logo-icon { display: block; }
.sidebar.collapsed .sidebar-logo { padding: 18px 0; display: flex; justify-content: center; }

.nav-section { padding: 20px 0 6px; overflow: hidden; }
.nav-label {
  font-size: .58rem; font-weight: 600; letter-spacing: .14em;
  text-transform: uppercase; color: #3d4460;
  padding: 0 22px 8px; white-space: nowrap;
  transition: opacity .2s;
}
.sidebar.collapsed .nav-label { opacity: 0; height: 0; padding: 0; margin: 0; }

.nav-item {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 22px; font-size: .78rem; font-weight: 500;
  color: #7b829e; cursor: pointer;
  border-left: 2px solid transparent; transition: all .15s;
  white-space: nowrap; overflow: hidden;
  position: relative;
}
.nav-item:hover { color: #fff; background: rgba(255,255,255,.04); }
.nav-item.active { color: #fff; border-left-color: var(--accent); background: rgba(37,99,235,.12); }
.nav-icon { font-size: .95rem; width: 18px; min-width: 18px; text-align: center; flex-shrink: 0; opacity: .8; }
.nav-text { opacity: 1; transition: opacity .15s; }
.sidebar.collapsed .nav-text { opacity: 0; }
.sidebar.collapsed .nav-item { padding: 10px 0; justify-content: center; border-left: 2px solid transparent; }
.sidebar.collapsed .nav-item.active { border-left-color: transparent; border-right: 2px solid var(--accent); background: rgba(37,99,235,.12); }

/* Tooltip on collapsed */
.sidebar.collapsed .nav-item { position: relative; }
.sidebar.collapsed .nav-item::after {
  content: attr(data-tip);
  position: absolute; left: 64px; top: 50%; transform: translateY(-50%);
  background: #2d3348; color: #fff; font-size: .72rem; font-weight: 500;
  padding: 4px 10px; border-radius: 6px; white-space: nowrap;
  pointer-events: none; opacity: 0; transition: opacity .15s;
  box-shadow: 0 2px 8px rgba(0,0,0,.2); z-index: 50;
}
.sidebar.collapsed .nav-item:hover::after { opacity: 1; }

/* Sync panel */
.sync-panel {
  margin-top: auto; padding: 16px 22px 22px;
  border-top: 1px solid rgba(255,255,255,.05);
}
.sync-label { font-size: .58rem; color: #3d4460; font-weight: 600; text-transform: uppercase; letter-spacing: .1em; margin-bottom: 7px; }
.sync-row { display: flex; align-items: center; gap: 7px; font-size: .72rem; font-weight: 500; margin-bottom: 4px; }
.sync-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.sync-dot.live { background: #4ade80; box-shadow: 0 0 6px #4ade80; animation: blink 2s infinite; }
.sync-dot.loading { background: #fbbf24; animation: blink .7s infinite; }
.sync-dot.error { background: #f87171; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
.sync-time { font-size: .64rem; color: #3d4460; margin-bottom: 2px; }
.sync-cd { font-size: .62rem; color: #3d4460; }
.btn-sync {
  width: 100%; margin-top: 10px; padding: 7px;
  background: rgba(37,99,235,.12); border: 1px solid rgba(37,99,235,.25);
  color: #7aa4f8; border-radius: 7px; font-family: var(--font);
  font-size: .72rem; font-weight: 600; cursor: pointer; transition: all .15s;
}
.btn-sync:hover { background: rgba(37,99,235,.22); color: #fff; }
.btn-sync:disabled { opacity: .45; cursor: not-allowed; }

/* Sync panel collapsed */
.sync-panel-text { transition: opacity .2s; }
.sidebar.collapsed .sync-panel-text { opacity: 0; pointer-events: none; height: 0; overflow: hidden; margin: 0; }
.sidebar.collapsed .sync-panel { padding: 12px 0; display: flex; flex-direction: column; align-items: center; gap: 6px; }
.sidebar.collapsed .btn-sync { width: 34px; height: 34px; padding: 0; border-radius: 8px; font-size: .9rem; display: flex; align-items: center; justify-content: center; overflow: hidden; }

/* â”€â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { margin-left: 240px; flex: 1; transition: margin-left .25s cubic-bezier(.4,0,.2,1); }
.main.collapsed { margin-left: 58px; }
.topbar {
  background: var(--surface); border-bottom: 1px solid var(--border);
  padding: 14px 30px; display: flex; align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 10; box-shadow: 0 1px 4px rgba(0,0,0,.04);
}
.topbar-title h1 { font-size: 1rem; font-weight: 600; }
.topbar-title p { color: var(--muted); font-size: .71rem; margin-top: 1px; font-weight: 400; }
.topbar-right { display: flex; align-items: center; gap: 10px; }
.live-badge {
  display: flex; align-items: center; gap: 6px;
  background: var(--green-bg); color: var(--green);
  border-radius: 20px; padding: 4px 12px;
  font-size: .68rem; font-weight: 600;
}
.live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: blink 2s infinite; }
.btn {
  padding: 6px 14px; border-radius: 7px; font-family: var(--font);
  font-size: .74rem; font-weight: 500; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface);
  color: var(--text); transition: all .15s;
}
.btn:hover { background: var(--surface2); }
.btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }
.btn-primary:hover { background: var(--accent2); }

/* â”€â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-overlay {
  position: fixed; inset: 0; background: rgba(26,29,46,.6);
  display: flex; align-items: center; justify-content: center;
  z-index: 100; backdrop-filter: blur(3px); transition: opacity .3s;
}
.loading-overlay.hidden { opacity: 0; pointer-events: none; }
.loading-box {
  background: var(--surface); border-radius: 14px;
  padding: 36px 48px; text-align: center; box-shadow: var(--shadow-md);
}
.loading-spinner {
  width: 40px; height: 40px; border: 3px solid var(--surface2);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .75s linear infinite; margin: 0 auto 14px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-title { font-size: .95rem; font-weight: 600; margin-bottom: 5px; }
.loading-sub { font-size: .76rem; color: var(--muted); font-weight: 400; }

/* Error */
.error-banner {
  background: var(--amber-bg); border: 1px solid #fcd34d;
  border-radius: var(--radius); padding: 12px 18px;
  margin: 16px 30px 0; display: none; gap: 10px; align-items: flex-start;
}
.error-banner.show { display: flex; }
.error-text { font-size: .76rem; color: var(--amber); font-weight: 400; }
.error-text strong { display: block; margin-bottom: 2px; font-weight: 600; color: #92400e; }

/* â”€â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content { padding: 24px 30px; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* â”€â”€â”€ KPI CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; margin-bottom: 18px; }
.kpi-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 18px 20px;
  box-shadow: var(--shadow); transition: box-shadow .2s;
  animation: fadeUp .35s ease both;
}
.kpi-card:hover { box-shadow: var(--shadow-md); }
.kpi-card:nth-child(1){animation-delay:.04s} .kpi-card:nth-child(2){animation-delay:.08s}
.kpi-card:nth-child(3){animation-delay:.12s} .kpi-card:nth-child(4){animation-delay:.16s}
.kpi-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
.kpi-icon {
  width: 34px; height: 34px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: .9rem; background: var(--tag-bg); color: var(--accent);
}
.kpi-label { font-size: .64rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .07em; }
.kpi-value { font-size: 1.55rem; font-weight: 700; letter-spacing: -.02em; line-height: 1; margin-bottom: 5px; color: var(--text); }
.kpi-sub { font-size: .67rem; color: var(--muted); font-weight: 400; }
.kpi-sub b { color: var(--green); font-weight: 600; }
.kpi-accent-blue { color: var(--accent); }
.kpi-accent-green { color: var(--green); }
.kpi-accent-red { color: var(--red); }
.kpi-accent-amber { color: var(--amber); }

/* â”€â”€â”€ SUMMARY STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.summary-strip { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; margin-bottom: 18px; }
.summary-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 20px;
  box-shadow: var(--shadow); display: flex; align-items: center; gap: 14px;
  animation: fadeUp .35s .2s ease both;
}
.summary-icon { font-size: 1.3rem; }
.s-label { font-size: .62rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .07em; }
.s-value { font-size: 1rem; font-weight: 700; letter-spacing: -.01em; margin-top: 1px; }
.s-note { font-size: .65rem; color: var(--muted); margin-top: 1px; font-weight: 400; }

/* â”€â”€â”€ CARD BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px 22px;
  box-shadow: var(--shadow); animation: fadeUp .35s .24s ease both;
}
.card-head { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
.card-title { font-size: .82rem; font-weight: 600; }
.card-sub { font-size: .67rem; color: var(--muted); margin-top: 2px; font-weight: 400; }
.divider { height: 1px; background: var(--border); margin: 14px 0; }

/* â”€â”€â”€ CHARTS ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.charts-row { display: grid; grid-template-columns: 3fr 2fr; gap: 14px; margin-bottom: 18px; }

/* Stage / budget bars */
.bar-list { display: flex; flex-direction: column; gap: 8px; }
.bar-row { display: flex; align-items: center; gap: 10px; }
.bar-label { font-size: .72rem; font-weight: 500; width: 178px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text); }
.bar-track { flex: 1; height: 6px; background: var(--surface2); border-radius: 99px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 99px; background: var(--accent); transition: width .7s cubic-bezier(.4,0,.2,1); }
.bar-count { font-size: .68rem; font-weight: 600; width: 24px; text-align: right; flex-shrink: 0; color: var(--muted); }

/* Budget bars */
.bdg-header { display: flex; justify-content: space-between; font-size: .68rem; margin-bottom: 3px; }
.bdg-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
.bdg-val { color: var(--muted); }

/* Donut */
.donut-legend { display: flex; flex-direction: column; gap: 7px; }
.legend-row { display: flex; align-items: center; gap: 8px; font-size: .72rem; }
.legend-dot { width: 9px; height: 9px; border-radius: 3px; flex-shrink: 0; background: var(--accent); }
.legend-name { flex: 1; color: var(--muted); font-weight: 400; }
.legend-val { font-weight: 600; font-size: .69rem; color: var(--text); }

/* â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); box-shadow: var(--shadow);
  margin-bottom: 18px; overflow: hidden;
  animation: fadeUp .35s .28s ease both;
}
.table-head {
  padding: 16px 22px 13px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 8px;
}
.filter-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.filter-btn {
  padding: 4px 12px; border-radius: 20px;
  font-size: .67rem; font-weight: 500; cursor: pointer;
  border: 1px solid var(--border); background: var(--surface2);
  color: var(--muted); font-family: var(--font); transition: all .15s;
}
.filter-btn.active, .filter-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); font-weight: 600; }
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead th {
  font-size: .62rem; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: .08em;
  padding: 8px 14px; text-align: left;
  border-bottom: 1px solid var(--border); background: var(--surface2);
  white-space: nowrap;
}
tbody td { padding: 10px 14px; font-size: .77rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover td { background: #fafbff; }
.proj-name { font-weight: 600; max-width: 220px; font-size: .78rem; }
.tag { display: inline-block; font-size: .59rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; white-space: nowrap; background: var(--tag-bg); color: var(--tag-color); }
.stage-chip { font-size: .59rem; font-weight: 600; padding: 2px 8px; border-radius: 4px; white-space: nowrap; background: var(--surface2); color: var(--muted); }
.progress-cell { display: flex; align-items: center; gap: 7px; }
.mini-bar { width: 56px; height: 5px; background: var(--surface2); border-radius: 99px; overflow: hidden; flex-shrink: 0; }
.mini-fill { height: 100%; border-radius: 99px; background: var(--accent); }
.pct-text { font-size: .68rem; font-weight: 600; color: var(--text); }
.cost-cell { font-size: .74rem; font-weight: 600; }
.status-pill { display: inline-flex; align-items: center; gap: 5px; padding: 3px 9px; border-radius: 20px; font-size: .62rem; font-weight: 600; white-space: nowrap; }
.pill-active { background: var(--green-bg); color: var(--green); }
.pill-inactive { background: var(--surface2); color: var(--muted); }

/* â”€â”€â”€ EMBED (small, bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.embed-section { margin-bottom: 18px; animation: fadeUp .35s .32s ease both; }
.embed-toggle {
  display: flex; align-items: center; gap: 8px;
  font-size: .74rem; font-weight: 500; color: var(--muted);
  cursor: pointer; padding: 10px 0; user-select: none;
}
.embed-toggle:hover { color: var(--accent); }
.embed-arrow { font-size: .7rem; transition: transform .2s; }
.embed-arrow.open { transform: rotate(90deg); }
.embed-inner { display: none; margin-top: 10px; }
.embed-inner.open { display: block; }
.embed-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);
}
.embed-bar {
  padding: 10px 16px; background: var(--surface2); border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
}
.embed-bar-title { font-size: .72rem; font-weight: 600; color: var(--muted); }

/* Fix instructions */
.fix-card {
  background: var(--amber-bg); border: 1px solid #fcd34d;
  border-radius: var(--radius); padding: 18px 22px; margin-bottom: 18px; display: none;
}
.fix-card.show { display: block; }
.fix-card h3 { font-size: .82rem; font-weight: 600; color: var(--amber); margin-bottom: 10px; }
.fix-card p { font-size: .76rem; color: var(--text); line-height: 1.75; font-weight: 400; }

::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-box">
    <div class="loading-spinner"></div>
    <div class="loading-title">Loading Dashboard</div>
    <div class="loading-sub" id="loadingMsg">Connecting to SharePointâ€¦</div>
  </div>
</div>

<div class="layout">

<!-- â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<aside class="sidebar" id="sidebar">
  <!-- Toggle button -->
  <div class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
  </div>

  <div class="sidebar-logo">
    <span class="logo-icon">ğŸ—ï¸</span>
    <div class="inst">IIT Bombay Â· Development Office</div>
    <div class="title">Infrastructure<br>Projects Dashboard</div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Main</div>
    <div class="nav-item active" onclick="showSection('overview',this)" data-tip="Overview">
      <span class="nav-icon">â–¦</span><span class="nav-text">Overview</span>
    </div>
    <div class="nav-item" onclick="showSection('financials',this)" data-tip="Financial Summary">
      <span class="nav-icon">â‚¹</span><span class="nav-text">Financial Summary</span>
    </div>
    <div class="nav-item" onclick="showSection('risks',this)" data-tip="Risks & Issues">
      <span class="nav-icon">âš </span><span class="nav-text">Risks &amp; Issues</span>
    </div>
  </div>

  <div class="nav-section">
    <div class="nav-label">Filter by Category</div>
    <div class="nav-item" onclick="filterTable('all',this)" data-tip="All Projects">
      <span class="nav-icon">â—ˆ</span><span class="nav-text">All Projects</span>
    </div>
    <div class="nav-item" onclick="filterTable('Academic',this)" data-tip="Academic">
      <span class="nav-icon">ğŸ“</span><span class="nav-text">Academic</span>
    </div>
    <div class="nav-item" onclick="filterTable('Student Housing',this)" data-tip="Student Housing">
      <span class="nav-icon">ğŸ </span><span class="nav-text">Student Housing</span>
    </div>
    <div class="nav-item" onclick="filterTable('Research',this)" data-tip="Research">
      <span class="nav-icon">ğŸ”¬</span><span class="nav-text">Research</span>
    </div>
    <div class="nav-item" onclick="filterTable('Non-academic',this)" data-tip="Non-Academic">
      <span class="nav-icon">ğŸ¢</span><span class="nav-text">Non-Academic</span>
    </div>
    <div class="nav-item" onclick="filterTable('Lab',this)" data-tip="Lab">
      <span class="nav-icon">âš—</span><span class="nav-text">Lab</span>
    </div>
  </div>

  <div class="sync-panel">
    <div class="sync-dot loading" id="syncDot" style="margin:0 auto 4px"></div>
    <div class="sync-panel-text">
      <div class="sync-label">Data Sync</div>
      <div class="sync-row">
        <span id="syncTxt" style="color:#7b829e">Connectingâ€¦</span>
      </div>
      <div class="sync-time" id="syncTime">â€”</div>
      <div class="sync-cd" id="syncCd"></div>
      <div style="font-size:.58rem;color:#3d4460;margin-top:8px;line-height:1.6">
        Auto-refresh every 5 min<br>Source: GitHub Â· auto-refresh 5min
      </div>
    </div>
    <button class="btn-sync" id="syncBtn" onclick="loadData()" disabled title="Sync Now">â†» <span class="nav-text">Sync Now</span></button>
  </div>
</aside>

<!-- â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main" id="mainContent">
  <div class="topbar">
    <div class="topbar-title">
      <h1>Infrastructure Projects Overview</h1>
      <p>IIT Bombay Development Office &nbsp;Â·&nbsp; All figures in INR Crores</p>
    </div>
    <div class="topbar-right">
      <div class="live-badge"><div class="live-dot"></div><span id="topStatus">Connectingâ€¦</span></div>
      <button class="btn" onclick="loadData()">â†» Refresh</button>
      <button class="btn btn-primary" onclick="window.open('https://iitbacr-my.sharepoint.com/:x:/p/siddhant_gupta/IQDZGAVhkBi9RpGhseTgjS3yAZSIPjE29jPJFxkzjTQWtKo?e=1mBM61','_blank')">â†— Open in SharePoint</button>
    </div>
  </div>

  <!-- Error -->
  <div class="error-banner" id="errorBanner">
    <span>âš ï¸</span>
    <div class="error-text">
      <strong>SharePoint CORS restriction</strong>
      Live fetch is blocked by browser security. Showing last uploaded data. The SharePoint embed below still reflects live edits.
      <a href="#fixCard" style="color:var(--amber);font-weight:600"> â†’ How to fix</a>
    </div>
  </div>

  <div class="content">

    <!-- Overview Section -->
    <div id="sec-overview">

      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-top"><div><div class="kpi-label">Total Projects</div></div><div class="kpi-icon">ğŸ—ï¸</div></div>
          <div class="kpi-value kpi-accent-blue" id="k1">â€”</div>
          <div class="kpi-sub" id="k1s">Loadingâ€¦</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-top"><div><div class="kpi-label">Total Estimated Cost</div></div><div class="kpi-icon">ğŸ“‹</div></div>
          <div class="kpi-value" id="k2">â€”</div>
          <div class="kpi-sub" id="k2s">Loadingâ€¦</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-top"><div><div class="kpi-label">Funds Committed</div></div><div class="kpi-icon">âœ“</div></div>
          <div class="kpi-value kpi-accent-green" id="k3">â€”</div>
          <div class="kpi-sub" id="k3s">Loadingâ€¦</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-top"><div><div class="kpi-label">Funding Gap</div></div><div class="kpi-icon">â–³</div></div>
          <div class="kpi-value kpi-accent-red" id="k4">â€”</div>
          <div class="kpi-sub" id="k4s">Loadingâ€¦</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="summary-strip">
        <div class="summary-card">
          <div class="summary-icon">ğŸ›ï¸</div>
          <div><div class="s-label">Total Built-up Area</div><div class="s-value" id="sA">â€”</div><div class="s-note" id="sAN">â€”</div></div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">âœ…</div>
          <div><div class="s-label">Completed Projects</div><div class="s-value" id="sC">â€”</div><div class="s-note">Stage 5 &amp; Stage 8 completions</div></div>
        </div>
        <div class="summary-card">
          <div class="summary-icon">ğŸ“Š</div>
          <div><div class="s-label">Avg. Completion Rate</div><div class="s-value" id="sPct">â€”</div><div class="s-note" id="sPctN">â€”</div></div>
        </div>
      </div>

      <!-- Charts -->
      <div class="charts-row">
        <!-- Stage + Budget -->
        <div class="card">
          <div class="card-head">
            <div><div class="card-title">Projects by Stage</div><div class="card-sub">Distribution across all tracked projects</div></div>
          </div>
          <div class="bar-list" id="stageBars"><div style="color:var(--muted);font-size:.8rem">Loadingâ€¦</div></div>

          <div class="divider"></div>
          <div style="font-size:.68rem;font-weight:600;color:var(--muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:.06em">Top Projects â€” Committed vs Estimated Cost</div>
          <div id="budgetBars"><div style="color:var(--muted);font-size:.8rem">Loadingâ€¦</div></div>
        </div>

        <!-- Category Donut -->
        <div class="card" style="display:flex;flex-direction:column">
          <div class="card-head">
            <div><div class="card-title">Projects by Category</div><div class="card-sub">All tracked projects</div></div>
          </div>
          <div style="display:flex;justify-content:center;margin-bottom:16px">
            <svg width="144" height="144" viewBox="0 0 144 144" id="donutSvg">
              <circle cx="72" cy="72" r="50" fill="none" stroke="#f0f1f5" stroke-width="22"/>
              <text x="72" y="68" text-anchor="middle" font-size="19" font-weight="700" fill="#1a1d2e" font-family="Poppins,sans-serif" id="donutNum">â€”</text>
              <text x="72" y="82" text-anchor="middle" font-size="9" fill="#8b90a7" font-family="Poppins,sans-serif">Projects</text>
            </svg>
          </div>
          <div class="donut-legend" id="donutLgd"><div style="color:var(--muted);font-size:.8rem">Loadingâ€¦</div></div>
          <div class="divider"></div>
          <div style="font-size:.68rem;font-weight:600;color:var(--muted);margin-bottom:9px;text-transform:uppercase;letter-spacing:.06em">Avg Completion by Category</div>
          <div class="bar-list" id="catBars"><div style="color:var(--muted);font-size:.8rem">Loadingâ€¦</div></div>
        </div>
      </div>

      <!-- Table -->
      <div class="table-card">
        <div class="table-head">
          <div><div class="card-title">All Infrastructure Projects</div><div class="card-sub" id="tSub">Loadingâ€¦</div></div>
          <div class="filter-btns">
            <button class="filter-btn active" onclick="filterTable('all',this)">All</button>
            <button class="filter-btn" onclick="filterTable('Academic',this)">Academic</button>
            <button class="filter-btn" onclick="filterTable('Student Housing',this)">Hostels</button>
            <button class="filter-btn" onclick="filterTable('Research',this)">Research</button>
            <button class="filter-btn" onclick="filterTable('Non-academic',this)">Non-Academic</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Project Name</th><th>Category</th><th>Stage</th>
              <th>% Complete</th><th>Est. Cost (Cr)</th><th>Committed (Cr)</th>
              <th>Status</th><th>Target</th>
            </tr></thead>
            <tbody id="tBody"><tr><td colspan="8" style="text-align:center;color:var(--muted);padding:30px">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- SharePoint Embed â€” collapsed by default, small -->
      <div class="embed-section">
        <div class="embed-toggle" onclick="toggleEmbed(this)">
          <span class="embed-arrow">â–¶</span>
          <span>View Live Spreadsheet (SharePoint Embed)</span>
        </div>
        <div class="embed-inner" id="embedInner">
          <div class="embed-card">
            <div class="embed-bar">
              <span class="embed-bar-title">ğŸ“„ Infrastructure_Projects_Tracker â€” SharePoint Live View</span>
              <a href="https://iitbacr-my.sharepoint.com/:x:/p/siddhant_gupta/IQDZGAVhkBi9RpGhseTgjS3yAZSIPjE29jPJFxkzjTQWtKo?e=1mBM61" target="_blank" class="btn" style="font-size:.66rem;padding:4px 10px">â†— Open</a>
            </div>
            <iframe
              width="100%" height="340" frameborder="0" scrolling="no"
              src="https://iitbacr.sharepoint.com/sites/drf_projects/_layouts/15/Doc.aspx?sourcedoc={32d17fbb-b29e-4c72-a8f3-9b93644a04b7}&action=embedview&wdAllowInteractivity=False&wdHideGridlines=True&wdHideHeaders=True&wdDownloadButton=True&wdInConfigurator=True">
            </iframe>
          </div>
        </div>
      </div>

    </div><!-- /sec-overview -->

    <!-- Financials Section -->
    <div id="sec-financials" style="display:none">
      <div class="card" style="margin-bottom:18px">
        <div class="card-head"><div><div class="card-title">Financial Summary</div><div class="card-sub">Committed vs estimated cost breakdown</div></div></div>
        <div id="finTable"></div>
      </div>
    </div>

    <!-- Risks Section -->
    <div id="sec-risks" style="display:none">
      <div class="card" style="margin-bottom:18px">
        <div class="card-head"><div><div class="card-title">Risks &amp; Issues</div><div class="card-sub">Projects with funding gaps or blocked status</div></div></div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Project Name</th><th>Category</th><th>Stage</th>
              <th>Funding Gap (Cr)</th><th>% Complete</th><th>Status</th>
            </tr></thead>
            <tbody id="riskBody"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Fix instructions -->
    <div class="fix-card" id="fixCard">
      <h3>âš™ï¸ How to Enable Full Live Sync</h3>
      <p>
        SharePoint CORS policy blocks direct browser fetches. The iframe embed above always shows live data.<br>
        To also drive KPIs/charts from live data, publish the "Projects Tracker" sheet as a CSV:<br><br>
        <strong>Excel Online â†’ File â†’ Share â†’ Publish to web â†’ Sheet: Projects Tracker â†’ Format: CSV â†’ Publish</strong><br>
        Copy the URL â†’ open this HTML file â†’ replace <code>FETCH_URL</code> near the bottom â†’ save.
      </p>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /layout -->

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ DATA SOURCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetches your Excel directly from GitHub (no CORS issues).
// To update data: upload new Excel to GitHub repo with same filename "data.xlsx"
// This URL never needs to change â€” only update YOUR_GITHUB_USERNAME once after setup.
const GITHUB_USERNAME = "YOUR_GITHUB_USERNAME"; // â† change this once
const REPO_NAME = "iitb-infrastructure-dashboard";
const FETCH_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/main/data.xlsx`;
const REFRESH_SECS = 300;

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ALL = [], curFilter = 'all', cdTimer = null, countdown = REFRESH_SECS;

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const crore = v => v ? (v/1e7) : 0;
const fmtCr = v => v && !isNaN(v) ? 'â‚¹' + (crore(v) >= 100 ? Math.round(crore(v)) : crore(v).toFixed(1)) + ' Cr' : 'â€”';
const fmtCrN = v => v && !isNaN(v) ? crore(v).toFixed(1) : null;
const fmtArea = v => !v || isNaN(v) ? 'â€”' : v >= 1e6 ? (v/1e6).toFixed(2)+'M sq ft' : Math.round(v).toLocaleString('en-IN')+' sq ft';

// Single accent colour for all chart bars â€” just vary opacity/lightness
const STAGE_COLORS = {
  'Stage1-Planning':       '#2563eb',
  'Stage2-Design':         '#3b5de7',
  'Stage3-Under Construction': '#16a34a',
  'Stage5-Completed':      '#0891b2',
  'Stage8- Completed':     '#0284c7',
  'Completed and Active':  '#0284c7',
};
const CAT_COLORS = {
  'Academic':         '#2563eb',
  'Student Housing':  '#16a34a',
  'Research':         '#7c3aed',
  'Non-academic':     '#b45309',
  'Lab':              '#0891b2',
  'Other':            '#8b90a7',
};

function stageClr(s) {
  if (!s) return '#8b90a7';
  return Object.entries(STAGE_COLORS).find(([k]) => s.includes(k.replace(/Stage\d[-â€“]/,'').split(' ')[0]))?.[1] || '#8b90a7';
}
function catClr(c) { return CAT_COLORS[(c||'').trim()] || CAT_COLORS.Other; }

function setSyncUI(state, msg) {
  document.getElementById('syncDot').className = 'sync-dot ' + state;
  document.getElementById('syncTxt').textContent = msg;
  document.getElementById('topStatus').textContent =
    state === 'live' ? 'Live Â· GitHub' : state === 'loading' ? 'Refreshingâ€¦' : 'Cached Data';
}
function setSyncTime() {
  document.getElementById('syncTime').textContent =
    'Last synced: ' + new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
}

// â”€â”€ PARSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseXLSX(buf) {
  const wb = XLSX.read(buf, { type: 'array', cellDates: true });
  const sn = wb.SheetNames.find(n => n.toLowerCase().includes('projects tracker')) || wb.SheetNames[0];
  return XLSX.utils.sheet_to_json(wb.Sheets[sn], { defval: null })
    .filter(r => r['Project Name'] && r['Project Name'].toString().trim())
    .map(r => ({
      name:      (r['Project Name'] || '').toString().trim(),
      category:  (r['Category'] || '').toString().trim(),
      area:      parseFloat(r['Built-up Area (sq ft)']) || null,
      cost:      parseFloat(r['Project Cost']) || null,
      committed: parseFloat(r['Funds Committed (After Admin Cost)']) || null,
      status:    (r['Status'] || 'Active').toString().trim(),
      pct:       parseFloat(r['% Completion']) || null,
      progress:  (r['Progress'] || '').toString().trim(),
      target:    r['Target Completion'],
    }));
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(projects) {
  ALL = projects;

  // KPIs
  const active = projects.filter(p => p.status === 'Active');
  const totalCost = projects.reduce((s,p) => s + (p.cost||0), 0);
  const totalComm = projects.reduce((s,p) => s + (p.committed||0), 0);
  const gap = Math.max(0, totalCost - totalComm);
  const pctComm = totalCost > 0 ? (totalComm/totalCost*100).toFixed(1) : 0;

  document.getElementById('k1').textContent = projects.length;
  document.getElementById('k1s').innerHTML = `<b>${active.length} Active</b> &nbsp;Â·&nbsp; ${projects.length - active.length} Non-Active`;
  document.getElementById('k2').textContent = fmtCr(totalCost);
  document.getElementById('k2s').textContent = 'Across all infrastructure projects';
  document.getElementById('k3').textContent = fmtCr(totalComm);
  document.getElementById('k3s').innerHTML = `<b>${pctComm}%</b> of total estimated cost`;
  document.getElementById('k4').textContent = fmtCr(gap);
  document.getElementById('k4s').textContent = gap > 0 ? `${(100-pctComm).toFixed(1)}% still to be committed` : 'Fully funded';

  // Summary
  const totalArea = projects.reduce((s,p) => s + (p.area||0), 0);
  document.getElementById('sA').textContent = fmtArea(totalArea);
  document.getElementById('sAN').textContent = `Across ${projects.filter(p=>p.area).length} buildings with area data`;
  const comp = projects.filter(p => p.progress && (p.progress.includes('Completed') || p.progress.includes('Stage5') || p.progress.includes('Stage8')));
  document.getElementById('sC').textContent = comp.length + ' Projects';
  const withPct = projects.filter(p => p.pct && !isNaN(p.pct));
  const avgPct = withPct.length ? (withPct.reduce((s,p) => s + p.pct, 0) / withPct.length * 100).toFixed(1) : 0;
  document.getElementById('sPct').textContent = avgPct + '%';
  document.getElementById('sPctN').textContent = `Across ${withPct.length} projects with data`;

  // Stage bars
  const stages = {};
  projects.forEach(p => { const s = p.progress || 'Unknown'; stages[s] = (stages[s]||0)+1; });
  const maxS = Math.max(...Object.values(stages));
  document.getElementById('stageBars').innerHTML = Object.entries(stages)
    .sort((a,b) => b[1]-a[1])
    .map(([s,n]) => {
      const col = stageClr(s);
      return `<div class="bar-row">
        <div class="bar-label" title="${s}">${s}</div>
        <div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/maxS*100)}%;background:${col}"></div></div>
        <div class="bar-count" style="color:${col}">${n}</div>
      </div>`;
    }).join('');

  // Budget bars (top 6)
  const top6 = [...projects].filter(p=>p.cost).sort((a,b)=>(b.cost||0)-(a.cost||0)).slice(0,6);
  document.getElementById('budgetBars').innerHTML = top6.map((p,i) => {
    const comm = p.committed || 0;
    const pct = p.cost > 0 ? Math.min(100, Math.round(comm/p.cost*100)) : 0;
    const over = comm > p.cost;
    // Slightly varying shades of accent blue
    const shades = ['#2563eb','#3b6fe8','#1d4ed8','#4f7af0','#1e40af','#3b82f6'];
    return `<div style="margin-bottom:8px">
      <div class="bdg-header">
        <span class="bdg-name" title="${p.name}">${p.name}</span>
        <span class="bdg-val">${fmtCrN(comm)||'0'} / ${fmtCrN(p.cost)||'â€”'} Cr${over?' âš ï¸':''}</span>
      </div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${shades[i]}"></div></div>
    </div>`;
  }).join('');

  // Donut
  const cats = {};
  projects.forEach(p => { const c = (p.category||'Other').trim() || 'Other'; cats[c] = (cats[c]||0)+1; });
  const total = projects.length;
  document.getElementById('donutNum').textContent = total;
  const circ = 2 * Math.PI * 50; // ~314.16
  const svg = document.getElementById('donutSvg');
  svg.querySelectorAll('.seg').forEach(e => e.remove());
  let off = 0;
  Object.entries(cats).sort((a,b) => b[1]-a[1]).forEach(([cat, n]) => {
    const col = catClr(cat);
    const arc = n / total * circ;
    const el = document.createElementNS('http://www.w3.org/2000/svg','circle');
    el.setAttribute('class','seg');
    el.setAttribute('cx','72'); el.setAttribute('cy','72'); el.setAttribute('r','50');
    el.setAttribute('fill','none'); el.setAttribute('stroke',col); el.setAttribute('stroke-width','22');
    el.setAttribute('stroke-dasharray',`${arc} ${circ}`);
    el.setAttribute('stroke-dashoffset', -off);
    el.setAttribute('transform','rotate(-90 72 72)');
    svg.insertBefore(el, svg.querySelector('text'));
    off += arc;
  });
  document.getElementById('donutLgd').innerHTML = Object.entries(cats).sort((a,b)=>b[1]-a[1]).map(([cat,n]) => {
    const col = catClr(cat);
    return `<div class="legend-row">
      <div class="legend-dot" style="background:${col}"></div>
      <span class="legend-name">${cat}</span>
      <span class="legend-val">${n} &nbsp;(${Math.round(n/total*100)}%)</span>
    </div>`;
  }).join('');

  // Category completion bars
  const catComps = {};
  Object.keys(cats).forEach(cat => {
    const ps = projects.filter(p => (p.category||'Other').trim()===cat && p.pct && !isNaN(p.pct));
    if (ps.length) catComps[cat] = Math.round(ps.reduce((s,p)=>s+p.pct,0)/ps.length*100);
  });
  document.getElementById('catBars').innerHTML = Object.entries(catComps).sort((a,b)=>b[1]-a[1]).map(([cat,pct]) => {
    const col = catClr(cat);
    return `<div class="bar-row">
      <div class="bar-label">${cat}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${col}"></div></div>
      <div class="bar-count" style="color:${col};width:34px">${pct}%</div>
    </div>`;
  }).join('');

  // Financials section
  document.getElementById('finTable').innerHTML = `
    <div class="table-wrap"><table>
      <thead><tr><th>Project</th><th>Category</th><th>Est. Cost (Cr)</th><th>Committed (Cr)</th><th>Gap (Cr)</th><th>% Funded</th></tr></thead>
      <tbody>
        ${[...projects].filter(p=>p.cost).sort((a,b)=>(b.cost||0)-(a.cost||0)).map(p => {
          const comm = p.committed || 0;
          const gap = Math.max(0, p.cost - comm);
          const pf = p.cost > 0 ? Math.round(comm/p.cost*100) : 0;
          return `<tr>
            <td class="proj-name">${p.name}</td>
            <td><span class="tag" style="background:${catClr(p.category)}18;color:${catClr(p.category)}">${p.category||'â€”'}</span></td>
            <td class="cost-cell">${fmtCrN(p.cost)||'â€”'}</td>
            <td class="cost-cell" style="color:var(--green)">${fmtCrN(comm)||'0'}</td>
            <td class="cost-cell" style="color:${gap>0?'var(--red)':'var(--green)'}">${gap>0?fmtCrN(gap*1e7)||'â€”':'Fully funded'}</td>
            <td><div class="progress-cell"><div class="mini-bar"><div class="mini-fill" style="width:${Math.min(pf,100)}%"></div></div><span class="pct-text">${pf}%</span></div></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table></div>`;

  // Risks section
  const risks = projects.filter(p => {
    const gap = (p.cost||0) - (p.committed||0);
    return gap > 1e7 || p.status === 'Non-Active';
  }).sort((a,b) => ((b.cost||0)-(b.committed||0)) - ((a.cost||0)-(a.committed||0)));
  document.getElementById('riskBody').innerHTML = risks.map(p => {
    const gap = Math.max(0, (p.cost||0) - (p.committed||0));
    const pctV = p.pct ? Math.round(p.pct*100) : null;
    return `<tr>
      <td class="proj-name">${p.name}</td>
      <td><span class="tag" style="background:${catClr(p.category)}18;color:${catClr(p.category)}">${p.category||'â€”'}</span></td>
      <td>${p.progress?`<span class="stage-chip">${p.progress}</span>`:'â€”'}</td>
      <td class="cost-cell" style="color:var(--red)">${gap>0?'â‚¹'+crore(gap).toFixed(1)+' Cr':'â€”'}</td>
      <td>${pctV!==null?`<div class="progress-cell"><div class="mini-bar"><div class="mini-fill" style="width:${Math.min(pctV,100)}%"></div></div><span class="pct-text">${pctV}%</span></div>`:'â€”'}</td>
      <td><span class="status-pill ${p.status==='Active'?'pill-active':'pill-inactive'}">${p.status==='Active'?'â— Active':'â—‹ '+p.status}</span></td>
    </tr>`;
  }).join('');

  document.getElementById('tSub').textContent = `${projects.length} projects Â· Live from SharePoint`;
  renderTable(curFilter, null);
}

// â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTable(filter, btn) {
  curFilter = filter;
  if (btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }
  const data = filter === 'all' ? ALL : ALL.filter(p => (p.category||'').trim() === filter);
  const tbody = document.getElementById('tBody');
  if (!data.length) { tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:24px">No projects found</td></tr>`; return; }
  tbody.innerHTML = data.map(p => {
    const catC = catClr(p.category);
    const pctV = p.pct && !isNaN(p.pct) ? Math.round(p.pct*100) : null;
    const pctD = pctV !== null
      ? `<div class="progress-cell"><div class="mini-bar"><div class="mini-fill" style="width:${Math.min(pctV,100)}%"></div></div><span class="pct-text">${pctV}%</span></div>`
      : 'â€”';
    let tgt = 'â€”';
    try { if (p.target) { const d = p.target instanceof Date ? p.target : new Date(p.target); if (!isNaN(d)) tgt = d.toLocaleDateString('en-IN',{month:'short',year:'numeric'}); else tgt = p.target.toString().substring(0,7); } } catch(e){}
    return `<tr>
      <td><div class="proj-name">${p.name}</div></td>
      <td>${p.category?`<span class="tag" style="background:${catC}18;color:${catC}">${p.category}</span>`:'â€”'}</td>
      <td>${p.progress?`<span class="stage-chip">${p.progress}</span>`:'â€”'}</td>
      <td>${pctD}</td>
      <td class="cost-cell">${p.cost?'â‚¹'+fmtCrN(p.cost)+' Cr':'â€”'}</td>
      <td class="cost-cell" style="color:var(--green)">${p.committed?'â‚¹'+fmtCrN(p.committed)+' Cr':'â€”'}</td>
      <td><span class="status-pill ${p.status==='Active'?'pill-active':'pill-inactive'}">${p.status==='Active'?'â— Active':'â—‹ '+p.status}</span></td>
      <td style="color:var(--muted);font-size:.71rem">${tgt}</td>
    </tr>`;
  }).join('');
}

// â”€â”€ SECTION SWITCHING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSection(id, navEl) {
  ['overview','financials','risks'].forEach(s => {
    document.getElementById('sec-'+s).style.display = s===id ? '' : 'none';
  });
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  if (navEl) navEl.classList.add('active');
}

// â”€â”€ EMBED TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEmbed(el) {
  const inner = document.getElementById('embedInner');
  const arrow = el.querySelector('.embed-arrow');
  const isOpen = inner.classList.toggle('open');
  arrow.classList.toggle('open', isOpen);
}

// â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  setSyncUI('loading','Fetchingâ€¦');
  document.getElementById('syncBtn').disabled = true;
  document.getElementById('loadingOverlay').classList.remove('hidden');

  let ok = false;
  try {
    const r = await fetch(FETCH_URL);
    if (r.ok) {
      const buf = await r.arrayBuffer();
      const projects = parseXLSX(buf);
      if (projects.length > 0) {
        render(projects);
        setSyncUI('live','Live Â· GitHub');
        setSyncTime();
        document.getElementById('errorBanner').classList.remove('show');
        ok = true;
      }
    }
  } catch(e) { console.warn('SharePoint fetch blocked:', e.message); }

  if (!ok) {
    setSyncUI('error','Cached data');
    document.getElementById('errorBanner').classList.add('show');
    render(FALLBACK);
  }

  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('syncBtn').disabled = false;
  startCountdown();
}

function startCountdown() {
  countdown = REFRESH_SECS;
  if (cdTimer) clearInterval(cdTimer);
  cdTimer = setInterval(() => {
    countdown--;
    const m = Math.floor(countdown/60), s = countdown%60;
    document.getElementById('syncCd').textContent = `Next refresh in ${m}:${s.toString().padStart(2,'0')}`;
    if (countdown <= 0) { clearInterval(cdTimer); loadData(); }
  }, 1000);
}

// â”€â”€ FALLBACK DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FALLBACK = [
  {name:"Girls Hostel",category:"Student Housing",area:51451,cost:3000000000,committed:0,status:"Active",pct:.81,progress:"Stage1-Planning",target:"2026-09-12"},
  {name:"ASB1",category:"Academic",area:353282,cost:2180000000,committed:0,status:"Active",pct:.99,progress:"Stage3-Under Construction",target:"2026-12-01"},
  {name:"AB3",category:"Academic",area:299024,cost:2580000000,committed:970000000,status:"Active",pct:.99,progress:"Stage2-Design",target:"2027-12-01"},
  {name:"AB1",category:"Academic",area:386209,cost:1900000000,committed:997000000,status:"Active",pct:.99,progress:"Stage3-Under Construction",target:"2027-04-01"},
  {name:"Hostel 6",category:"Student Housing",area:423022,cost:1800000000,committed:1050000000,status:"Active",pct:0,progress:"Stage1-Planning",target:"2028-03-01"},
  {name:"Hostel 9",category:"Student Housing",area:322917,cost:1650000000,committed:643293750,status:"Active",pct:0,progress:"Stage2-Design",target:"2028-03-01"},
  {name:"Hostel 4",category:"Student Housing",area:398426,cost:1600000000,committed:200000000,status:"Active",pct:1,progress:"Completed and Active",target:"2025"},
  {name:"Hostel 11",category:"Student Housing",area:51432,cost:1600000000,committed:0,status:"Active",pct:null,progress:"Stage1-Planning",target:"2028"},
  {name:"Research HUB",category:"Research",area:160500,cost:1410000000,committed:0,status:"Active",pct:.99,progress:"Stage2-Design",target:"2027-12-01"},
  {name:"Hostel 19",category:"Student Housing",area:360791,cost:1000000000,committed:0,status:"Active",pct:null,progress:"Stage5-Completed",target:"2025-12-01"},
  {name:"Faculty Housing",category:"Non-academic",area:455452,cost:1000000000,committed:0,status:"Active",pct:null,progress:"Stage3-Under Construction",target:null},
  {name:"ASB2",category:"Academic",area:115970,cost:900000000,committed:1024500000,status:"Active",pct:.99,progress:"Stage3-Under Construction",target:"2026-12-01"},
  {name:"Rahul Bajaj TIC",category:"Research",area:208460,cost:700000000,committed:250000000,status:"Non-Active",pct:null,progress:"Stage8- Completed",target:null},
  {name:"DESAI SETHI School",category:"Research",area:134506,cost:600000000,committed:233006082,status:"Active",pct:1,progress:"Stage8- Completed",target:"2025-08-01"},
  {name:"AB2",category:"Academic",area:null,cost:null,committed:562600000,status:"Active",pct:.99,progress:"Stage3-Under Construction",target:"2027-04-01"},
  {name:"KV",category:"Non-academic",area:0,cost:0,committed:599480000,status:"Active",pct:.99,progress:"Stage3-Under Construction",target:"2026-12-01"},
  {name:"NSAC",category:"Academic",area:57242,cost:450000000,committed:0,status:"Active",pct:1,progress:"Completed and Active",target:"2026-07-01"},
  {name:"Alumni Centre",category:"Non-academic",area:155454,cost:110000000,committed:164500000,status:"Active",pct:1,progress:"Stage2-Design",target:"2028"},
  {name:"COPT-BETIC",category:"Research",area:156496,cost:99000000,committed:142700000,status:"Active",pct:.99,progress:"Completed and Active",target:"2026-10-01"},
  {name:"A91 Eco Hub",category:"Research",area:54235,cost:90000000,committed:155200000,status:"Non-Active",pct:1,progress:"Completed and Active",target:"2024"},
  {name:"Efficiency Appt",category:"Non-academic",area:502675,cost:226000000,committed:0,status:"Active",pct:null,progress:"Stage2-Design",target:null},
  {name:"Gogri Hub",category:"Lab",area:null,cost:72750000,committed:72750000,status:"Active",pct:1,progress:"Stage3-Under Construction",target:"2026-01-01"},
  {name:"ARL",category:"Academic",area:112742,cost:170000000,committed:0,status:"Active",pct:.99,progress:"Stage1-Planning",target:"2027-08-01"},
  {name:"Lecture Hall Complex",category:"Academic",area:129898,cost:120000000,committed:0,status:"Active",pct:null,progress:"Stage1-Planning",target:null},
  {name:"MLCP",category:"Non-academic",area:215200,cost:140000000,committed:0,status:"Active",pct:null,progress:"Stage1-Planning",target:null},
  {name:"EHV",category:"Non-academic",area:38750,cost:127000000,committed:0,status:"Active",pct:null,progress:"Stage1-Planning",target:null},
  {name:"Drone Centre",category:"Academic",area:32280,cost:97000000,committed:0,status:"Active",pct:1,progress:"Stage1-Planning",target:"2027"},
  {name:"AB4 & GESH",category:"Academic",area:null,cost:null,committed:null,status:"Active",pct:.99,progress:"Stage2-Design",target:"2027-12-01"},
];

// â”€â”€ SIDEBAR TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const main = document.getElementById('mainContent');
  sidebar.classList.toggle('collapsed');
  main.classList.toggle('collapsed');
}

window.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
